<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS Learning: Sorting & Searching (M.4)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f3f4f6; }
        .bar { transition: all 0.3s ease; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .student-list::-webkit-scrollbar { width: 8px; }
        .student-list::-webkit-scrollbar-track { background: #f1f1f1; }
        .student-list::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

<div id="app" class="min-h-screen flex flex-col">

    <nav class="p-4 shadow-lg flex justify-between items-center z-40 transition-colors duration-300"
         :class="isAdmin ? 'bg-slate-800 text-white' : 'bg-indigo-600 text-white'">
        <div class="flex items-center gap-2">
            <i class="ph ph-database text-2xl"></i>
            <span class="text-xl font-bold">
                {{ isAdmin ? 'Teacher Panel (ระบบจัดการ)' : 'AlgoLearn (ม.4)' }}
            </span>
        </div>
        <div v-if="currentUser" class="flex items-center gap-4">
            <div class="text-right hidden sm:block">
                <div class="font-bold">{{ currentUser.name }}</div>
                <div class="text-xs opacity-80">
                    {{ isAdmin ? 'สถานะ: ครูผู้สอน' : `เลขที่: ${currentUser.student_number || '-'} (ID: ${currentUser.student_code})` }}
                </div>
            </div>
            <button @click="logout" class="bg-red-500 hover:bg-red-600 px-3 py-1 rounded text-sm transition shadow">
                <i class="ph ph-sign-out"></i> <span class="hidden sm:inline">ออกจากระบบ</span>
            </button>
        </div>
    </nav>

    <main class="flex-grow p-6 container mx-auto relative z-0">

        <transition name="fade">
        <div v-if="currentView === 'login'" class="flex flex-col items-center justify-center h-[80vh]">
            <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md text-center border-t-4 border-indigo-500 relative overflow-hidden">
                <h2 class="text-2xl font-bold mb-2 text-indigo-700">เข้าสู่ระบบห้องเรียน</h2>
                <p class="text-gray-500 mb-8">วิชาวิทยาการคอมพิวเตอร์ 1</p>
                
                <div class="mb-2 space-y-4 relative z-10">
                    <div>
                        <input v-model="loginInput" @keyup.enter="handleLogin" type="text" placeholder="กรอกรหัสนักเรียน / Admin" 
                               class="w-full p-4 border border-gray-300 rounded-xl focus:ring-4 focus:ring-indigo-100 focus:border-indigo-500 outline-none text-center text-lg transition-all shadow-sm">
                    </div>
                    <div v-if="showPasswordInput" class="animate-bounce-in">
                        <input v-model="passwordInput" @keyup.enter="handleLogin" type="password" placeholder="รหัสผ่านผู้สอน" 
                               class="w-full p-4 border border-gray-300 rounded-xl focus:ring-4 focus:ring-slate-200 focus:border-slate-500 outline-none text-center text-lg bg-slate-50 shadow-sm">
                    </div>
                    <button @click="handleLogin" :disabled="isLoading"
                            class="w-full text-white p-4 rounded-xl font-bold text-lg transition shadow-lg transform active:scale-95 flex justify-center items-center gap-2"
                            :class="showPasswordInput ? 'bg-slate-700 hover:bg-slate-800' : 'bg-indigo-600 hover:bg-indigo-700'">
                        <span v-if="!isLoading">{{ showPasswordInput ? 'ยืนยันตัวตน Admin' : 'เข้าสู่บทเรียน' }}</span>
                        <span v-else>กำลังโหลด...</span>
                    </button>
                    <p v-if="loginError" class="text-red-500 text-sm mt-2">{{ loginError }}</p>
                </div>
            </div>
            <p class="mt-6 text-gray-400 text-sm">System powered by Supabase</p>
        </div>
        </transition>

        <transition name="fade">
        <div v-if="currentView === 'teacher_dashboard'" class="py-4">
            <h1 class="text-2xl font-bold text-slate-700 mb-6 flex items-center gap-2">
                <i class="ph ph-control"></i> แผงควบคุมผู้สอน
            </h1>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-1 space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-green-500">
                        <h3 class="font-bold text-lg text-slate-800 mb-2">นำเข้าไฟล์ Excel</h3>
                        <p class="text-xs text-gray-500 mb-4">Col A: รหัส | Col B: ชื่อ | Col C: เลขที่</p>
                        <label class="cursor-pointer bg-green-50 hover:bg-green-100 text-green-700 w-full py-3 rounded-lg border border-green-200 border-dashed flex items-center justify-center gap-2 transition hover:shadow-md">
                            <i v-if="!isLoading" class="ph ph-microsoft-excel-logo text-xl"></i> 
                            <i v-else class="ph ph-spinner animate-spin text-xl"></i>
                            <span>{{ isLoading ? 'กำลังบันทึก...' : 'เลือกไฟล์ Excel' }}</span>
                            <input type="file" @change="handleFileUpload" class="hidden" accept=".xlsx, .xls" :disabled="isLoading">
                        </label>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-purple-500">
                        <h3 class="font-bold text-lg text-slate-800 mb-2">จัดการข้อมูล</h3>
                        <div class="space-y-3">
                            <button @click="fetchScores" class="w-full bg-purple-100 text-purple-700 py-2 rounded-lg hover:bg-purple-200 transition text-sm font-bold flex items-center justify-center gap-2">
                                <i class="ph ph-arrow-clockwise"></i> รีเฟรชข้อมูล
                            </button>
                            <button @click="deleteAllStudents" class="w-full bg-red-100 text-red-600 py-2 rounded-lg hover:bg-red-200 transition text-sm font-bold flex items-center justify-center gap-2 border border-red-200">
                                <i class="ph ph-trash"></i> ลบนักเรียนทั้งหมด
                            </button>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-slate-700 to-slate-800 text-white p-6 rounded-xl shadow-lg">
                        <h3 class="font-bold text-xl mb-4">โหมดการสอน (Demo)</h3>
                        <button @click="enterTeachingMode" class="w-full bg-white text-slate-900 py-3 rounded-lg font-bold hover:bg-blue-50 transition flex items-center justify-center gap-2 shadow-lg">
                            <i class="ph ph-presentation-chart"></i> เริ่มการสอน
                        </button>
                    </div>
                </div>
                <div class="md:col-span-2 bg-white rounded-xl shadow-md overflow-hidden flex flex-col h-[75vh]">
                    <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                        <h3 class="font-bold text-slate-700 flex items-center gap-2"><i class="ph ph-users"></i> รายชื่อและคะแนน ({{ studentData.length }})</h3>
                        <button @click="openEditModal(null)" class="text-xs bg-indigo-600 text-white px-3 py-1 rounded hover:bg-indigo-700 flex items-center gap-1"><i class="ph ph-plus"></i> เพิ่มนักเรียน</button>
                    </div>
                    <div class="overflow-y-auto student-list flex-grow p-0 relative">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-gray-100 text-gray-600 sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th class="p-3 text-sm font-semibold text-center w-16">เลขที่</th>
                                    <th class="p-3 text-sm font-semibold w-1/4">รหัส</th>
                                    <th class="p-3 text-sm font-semibold">ชื่อ-นามสกุล</th>
                                    <th class="p-3 text-sm font-semibold text-center w-24">คะแนน</th>
                                    <th class="p-3 text-sm font-semibold text-center w-28">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-if="studentData.length === 0"><td colspan="5" class="p-12 text-center text-gray-400">{{ isLoading ? 'กำลังดึงข้อมูล...' : 'ยังไม่มีข้อมูลนักเรียน' }}</td></tr>
                                <tr v-for="(student, idx) in studentData" :key="idx" class="border-b last:border-0 hover:bg-slate-50 transition group">
                                    <td class="p-3 text-center text-slate-500 font-mono">{{ student.student_number || '-' }}</td>
                                    <td class="p-3 text-slate-600 font-mono">{{ student.student_code }}</td>
                                    <td class="p-3 text-slate-800 font-medium">{{ student.name }}</td>
                                    <td class="p-3 text-center"><span v-if="student.score !== undefined" class="font-bold" :class="student.score >= 8 ? 'text-green-600' : 'text-orange-500'">{{ student.score }}</span><span v-else class="text-gray-300">-</span></td>
                                    <td class="p-3 text-center">
                                        <div class="flex justify-center gap-2">
                                            <button @click="openEditModal(student)" class="text-blue-500 hover:text-blue-700 bg-blue-50 p-1.5 rounded hover:bg-blue-100 transition"><i class="ph ph-pencil-simple"></i></button>
                                            <button @click="deleteStudent(student.id)" class="text-red-500 hover:text-red-700 bg-red-50 p-1.5 rounded hover:bg-red-100 transition"><i class="ph ph-trash"></i></button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        </transition>

        <transition name="fade">
            <div v-if="currentView === 'menu'" class="py-8">
                <div class="flex items-center justify-between mb-8">
                    <h1 class="text-3xl font-bold text-slate-700">เลือกหัวข้อการเรียนรู้</h1>
                    <button v-if="isAdmin" @click="currentView = 'teacher_dashboard'" class="flex items-center gap-2 text-slate-500 hover:text-slate-800 font-semibold bg-slate-200 px-4 py-2 rounded-lg transition"><i class="ph ph-arrow-left"></i> กลับหน้า Admin</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
                     <div v-for="algo in sortingAlgos" :key="algo.key" @click="selectTopic(algo)" class="bg-white p-6 rounded-xl shadow-md cursor-pointer card-hover border-l-4" :class="algo.color">
                        <div class="flex justify-between items-start mb-2"><h3 class="font-bold text-xl">{{ algo.name }}</h3></div>
                        <p class="text-sm text-gray-500">{{ algo.desc }}</p>
                    </div>
                     <div v-for="algo in searchingAlgos" :key="algo.key" @click="selectTopic(algo)" class="bg-white p-6 rounded-xl shadow-md cursor-pointer card-hover border-l-4" :class="algo.color">
                        <h3 class="font-bold text-xl mb-2">{{ algo.name }}</h3>
                        <p class="text-sm text-gray-500">{{ algo.desc }}</p>
                    </div>
                </div>
                <div class="text-center">
                    <button @click="startQuiz" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white text-xl font-bold px-10 py-4 rounded-full shadow-lg hover:scale-105 transition transform flex items-center gap-3 mx-auto"><i class="ph ph-exam text-3xl"></i> ทำแบบทดสอบ</button>
                </div>
            </div>
        </transition>

        <transition name="fade">
            <div v-if="currentView === 'content' && activeTopic" class="h-full">
               <button @click="currentView = 'menu'" class="mb-4 text-gray-500 hover:text-indigo-600 flex items-center gap-1 font-medium transition"><i class="ph ph-arrow-left"></i> กลับเมนูหลัก</button>
               <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full">
                   
                   <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md overflow-y-auto max-h-[85vh] space-y-6">
                       <div>
                           <h2 class="text-2xl font-bold mb-2 flex items-center gap-2" :class="activeTopic.textColor">
                               <i class="ph ph-book-bookmark"></i> {{ activeTopic.name }}
                           </h2>
                           <div class="p-3 bg-gray-50 rounded-lg text-sm font-mono border-l-4 border-gray-400">
                               <strong>CONCEPT:</strong> {{ activeTopic.concept }}
                           </div>
                       </div>

                       <div class="prose text-slate-600 text-sm leading-relaxed whitespace-pre-line">
                           {{ activeTopic.content }}
                       </div>

                       <div class="grid grid-cols-2 gap-4">
                           <div class="bg-green-50 p-3 rounded-lg border border-green-100">
                               <h4 class="font-bold text-green-700 text-sm mb-2 flex items-center gap-1"><i class="ph ph-thumbs-up"></i> จุดเด่น</h4>
                               <ul class="list-disc list-inside text-xs text-green-800 space-y-1">
                                   <li v-for="p in activeTopic.pros">{{ p }}</li>
                               </ul>
                           </div>
                           <div class="bg-red-50 p-3 rounded-lg border border-red-100">
                               <h4 class="font-bold text-red-700 text-sm mb-2 flex items-center gap-1"><i class="ph ph-thumbs-down"></i> จุดด้อย</h4>
                               <ul class="list-disc list-inside text-xs text-red-800 space-y-1">
                                   <li v-for="c in activeTopic.cons">{{ c }}</li>
                               </ul>
                           </div>
                       </div>

                       <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                           <h4 class="font-bold text-blue-700 text-sm mb-2 flex items-center gap-1"><i class="ph ph-briefcase"></i> การประยุกต์ใช้ในงานจริง</h4>
                           <ul class="space-y-2">
                               <li v-for="app in activeTopic.apps" class="text-xs text-blue-900 flex items-start gap-2">
                                   <i class="ph ph-check-circle mt-0.5 text-blue-500"></i>
                                   <span>{{ app }}</span>
                               </li>
                           </ul>
                       </div>
                   </div>

                   <div class="lg:col-span-2 bg-slate-800 rounded-xl shadow-md p-6 flex flex-col items-center justify-center relative overflow-hidden min-h-[450px]">
                       <div class="flex items-end justify-center gap-1 h-64 w-full mb-8 px-4">
                           <div v-for="(val, idx) in dataArray" :key="idx" :style="{ height: val + 'px', backgroundColor: getBarColor(idx) }" class="flex-1 max-w-[40px] rounded-t bar flex items-end justify-center pb-1 text-[10px] text-white font-bold relative shadow-sm"><span v-if="dataArray.length<=20">{{val}}</span></div>
                       </div>
                       <div class="flex gap-4 justify-center z-10">
                           <button @click="resetArray" :disabled="isSorting" class="bg-gray-700 text-white px-6 py-2 rounded-full hover:bg-gray-600 transition">สุ่มใหม่</button>
                           <button @click="runAlgorithm" :disabled="isSorting" class="bg-green-500 text-white px-10 py-2 rounded-full font-bold shadow-lg flex items-center gap-2 hover:bg-green-600 transition">{{ isSorting ? '...' : 'เริ่ม' }}</button>
                       </div>
                       <div v-if="statusMessage" class="mt-8 text-yellow-300 font-mono text-sm bg-black/40 px-6 py-2 rounded-full">{{ statusMessage }}</div>
                   </div>
               </div>
            </div>
        </transition>

        <transition name="fade">
            <div v-if="currentView === 'quiz'" class="max-w-2xl mx-auto py-8">
                <div v-if="!quizFinished">
                    <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">แบบทดสอบ</h2><span>ข้อที่ {{currentQuestionIndex+1}}/{{quizQuestions.length}}</span></div>
                    <div class="bg-white p-8 rounded-2xl shadow-lg border-t-8 border-indigo-500">
                        <h3 class="text-xl font-semibold mb-8">{{quizQuestions[currentQuestionIndex].question}}</h3>
                        <div class="space-y-3">
                            <button v-for="(option, idx) in quizQuestions[currentQuestionIndex].options" :key="idx" @click="selectAnswer(idx)" class="w-full text-left p-4 rounded-xl border-2 transition" :class="selectedAnswer===idx?'bg-indigo-50 border-indigo-500':'border-gray-100'">{{['A','B','C','D'][idx]}}. {{option}}</button>
                        </div>
                    </div>
                    <div class="mt-8 flex justify-end"><button @click="nextQuestion" :disabled="selectedAnswer===null" class="bg-indigo-600 text-white px-10 py-3 rounded-full shadow-lg font-bold disabled:bg-gray-300">ถัดไป</button></div>
                </div>
                <div v-else class="text-center bg-white p-12 rounded-3xl shadow-2xl border-t-8" :class="score>=8?'border-green-500':'border-orange-500'">
                    <h2 class="text-3xl font-bold mb-2">ผลคะแนน</h2>
                    <p class="text-gray-500 mb-8">{{currentUser.name}}</p>
                    <div class="text-7xl font-black mb-2" :class="score>=8?'text-green-600':'text-orange-500'">{{score}}</div>
                    <div class="flex justify-center gap-4 mt-8">
                        <button @click="startQuiz" class="px-8 py-3 rounded-xl border-2 border-gray-200 hover:bg-gray-50">สอบแก้ตัว</button>
                        <button @click="currentView='menu'" class="bg-indigo-600 text-white px-8 py-3 rounded-xl shadow-lg">กลับเมนู</button>
                    </div>
                </div>
            </div>
        </transition>

    </main>

    <transition name="fade">
        <div v-if="showEditModal" class="fixed inset-0 z-50 flex items-center justify-center modal-overlay p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 relative">
                <h3 class="text-xl font-bold text-slate-700 mb-4">
                    {{ editingStudent.id ? 'แก้ไขข้อมูลนักเรียน' : 'เพิ่มนักเรียนใหม่' }}
                </h3>
                <div class="space-y-4">
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">เลขที่</label><input v-model="editingStudent.student_number" type="text" class="w-full p-2 border rounded focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="เช่น 01"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">รหัสนักเรียน (ห้ามซ้ำ)</label><input v-model="editingStudent.student_code" type="text" class="w-full p-2 border rounded focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="เช่น 66001"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">ชื่อ-นามสกุล</label><input v-model="editingStudent.name" type="text" class="w-full p-2 border rounded focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="เช่น เด็กชายรักดี มีวินัย"></div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button @click="showEditModal = false" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded transition">ยกเลิก</button>
                    <button @click="saveStudent" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition shadow">{{ isLoading ? 'กำลังบันทึก...' : 'บันทึก' }}</button>
                </div>
            </div>
        </div>
    </transition>

</div>

<script>
const { createApp, ref, computed } = Vue;
const SUPABASE_URL = 'https://bzfhixfeeenkknnilbgw.supabase.co'; 
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6ZmhpeGZlZWVua2tubmlsYmd3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxNjMxOTMsImV4cCI6MjA4NTczOTE5M30.gFjptTI5eB7RHOVsmwMi3QsKkmD35R5Poh6ofLDgOWo';

createApp({
    setup() {
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // State
        const currentView = ref('login');
        const loginInput = ref('');
        const passwordInput = ref('');
        const showPasswordInput = ref(false);
        const loginError = ref('');
        const currentUser = ref(null);
        const isLoading = ref(false);
        const isSavingScore = ref(false);
        const studentData = ref([]); 
        
        // Edit Modal State
        const showEditModal = ref(false);
        const editingStudent = ref({ id: null, student_code: '', name: '', student_number: '' });

        const activeTopic = ref(null);
        const dataArray = ref([]);
        const isSorting = ref(false);
        const activeIndices = ref([]); 
        const sortedIndices = ref([]); 
        const statusMessage = ref('');
        const isAdmin = computed(() => currentUser.value && currentUser.value.role === 'admin');

        // Content (Updated with Pros, Cons, Apps)
        const sortingAlgos=[
            {
                key:'bubble',name:'Bubble Sort',desc:'เรียงลำดับแบบฟองสบู่',color:'border-blue-400',textColor:'text-blue-600',
                concept:'เปรียบเทียบข้อมูลคู่ติดกัน ถ้าตัวหน้ามากกว่าตัวหลังให้สลับที่ ทำซ้ำจนกว่าจะเรียงเสร็จ',
                content:'Bubble Sort เป็นอัลกอริทึมที่ง่ายที่สุด ทำงานโดยการเปรียบเทียบข้อมูลที่อยู่ติดกันทีละคู่ และสลับตำแหน่งหากลำดับผิด (เช่น น้อยไปมาก แต่ตัวหน้ามากกว่าตัวหลัง) ทำแบบนี้ซ้ำๆ ข้อมูลที่มีค่ามากที่สุดจะ "ลอย" ไปอยู่ที่ท้ายสุดเหมือนฟองสบู่',
                apps: ['ใช้ในการเรียนการสอน Concept การเรียงลำดับ', 'ใช้กับชุดข้อมูลขนาดเล็กมากที่ความเร็วไม่ใช่เรื่องสำคัญ', 'ใช้ตรวจสอบความเรียบร้อยของข้อมูล (Data Verification)'],
                pros: ['เข้าใจง่าย เขียนโค้ดสั้น', 'ใช้หน่วยความจำน้อย (In-place)', 'ถ้าข้อมูลเรียงอยู่แล้วจะทำงานเร็ว (Best Case O(n))'],
                cons: ['ทำงานช้ามากกับข้อมูลเยอะ (O(n²))', 'มีการสลับข้อมูลบ่อยเกินความจำเป็น']
            },
            {
                key:'selection',name:'Selection Sort',desc:'เลือกค่าที่น้อยที่สุด',color:'border-green-400',textColor:'text-green-600',
                concept:'ค้นหาค่าที่น้อยที่สุดในส่วนที่ยังไม่เรียง แล้วนำมาวางต่อท้ายส่วนที่เรียงแล้ว',
                content:'Selection Sort ทำงานโดยแบ่งข้อมูลเป็น 2 ส่วน คือส่วนที่เรียงแล้วและส่วนที่ยังไม่เรียง ในแต่ละรอบ จะทำการค้นหา "ค่าที่น้อยที่สุด" จากส่วนที่ยังไม่เรียง แล้วสลับเอามานำไว้ในตำแหน่งแรกสุดของส่วนที่ยังไม่เรียง',
                apps: ['ระบบที่มีหน่วยความจำจำกัดมากๆ', 'ระบบที่การเขียนข้อมูล (Write) มีต้นทุนสูง (เช่น Flash Memory สมัยก่อน)', 'ใช้กับรายการของชิ้นเล็กๆ'],
                pros: ['มีการสลับข้อมูล (Swap) น้อยที่สุดเมื่อเทียบกับ Bubble Sort', 'เข้าใจง่าย รูปแบบการทำงานตายตัว'],
                cons: ['ทำงานช้า (O(n²)) เสมอ แม้ข้อมูลจะเรียงมาแล้ว', 'ไม่เสถียร (Unstable) ลำดับข้อมูลที่เท่ากันอาจเปลี่ยน']
            },
            {
                key:'insertion',name:'Insertion Sort',desc:'แทรกไพ่ในมือ',color:'border-yellow-400',textColor:'text-yellow-600',
                concept:'หยิบข้อมูลทีละตัว แล้วนำไป "แทรก" ในตำแหน่งที่ถูกต้องของกลุ่มข้อมูลที่เรียงแล้ว',
                content:'Insertion Sort เปรียบเสมือนการเรียงไพ่ในมือ เราจะหยิบไพ่ใบใหม่ขึ้นมา แล้วมองหาตำแหน่งที่ถูกต้องในกองไพ่ที่เราถืออยู่แล้วเสียบ (Insert) ไพ่นั้นลงไป ทำให้ไพ่ในมือเราเรียงลำดับถูกต้องเสมอ',
                apps: ['เรียงไพ่ในมือ', 'ใช้เรียงข้อมูลที่ทยอยเข้ามาทีละตัว (Online Algorithm)', 'ใช้เป็นขั้นตอนย่อยในอัลกอริทึมที่ซับซ้อนกว่า (เช่น Timsort ใน Python)'],
                pros: ['เร็วมากถ้าข้อมูล "เกือบจะเรียง" มาอยู่แล้ว', 'เสถียร (Stable) ลำดับข้อมูลที่เท่ากันไม่เปลี่ยน', 'เขียนง่ายและใช้หน่วยความจำน้อย'],
                cons: ['ช้ามากถ้าข้อมูลเรียงย้อนกลับ (Reverse Ordered)']
            },
            {
                key:'merge',name:'Merge Sort',desc:'แบ่งแยกและเอาชนะ',color:'border-purple-400',textColor:'text-purple-600',
                concept:'แบ่งข้อมูลเป็นกลุ่มย่อยจนเหลือตัวเดียว แล้วนำกลับมา "ผสาน" (Merge) กันโดยเรียงลำดับไปด้วย',
                content:'Merge Sort ใช้วิธี Divide and Conquer (แบ่งแยกและเอาชนะ) โดยแบ่งข้อมูลออกเป็นครึ่งไปเรื่อยๆ จนเหลือกลุ่มละ 1 ตัว จากนั้นเริ่มกระบวนการ Merge คือการนำกลุ่มย่อยมารวมกันโดยเปรียบเทียบค่าและเรียงให้ถูกต้อง',
                apps: ['ระบบ E-commerce ที่ต้องเรียงสินค้าตามราคา/ความนิยม', 'การเรียงข้อมูลไฟล์ขนาดใหญ่ใน Database (External Sorting)', 'ภาษา Java ใช้ Merge Sort ในการเรียง Object'],
                pros: ['ความเร็วคงที่เสมอ (O(n log n)) ไม่ว่าข้อมูลจะมั่วแค่ไหน', 'เสถียร (Stable) เหมาะกับการเรียงข้อมูลหลายชั้น'],
                cons: ['ใช้หน่วยความจำเพิ่ม (Space O(n)) เพื่อสร้างอาเรย์ชั่วคราว', 'เขียนโค้ดซับซ้อนกว่าแบบพื้นฐาน']
            },
            {
                key:'quick',name:'Quick Sort',desc:'เลือกจุดหมุน (Pivot)',color:'border-red-400',textColor:'text-red-600',
                concept:'เลือกค่า Pivot แบ่งข้อมูลเป็น 2 ฝั่ง (น้อยกว่า Pivot และ มากกว่า Pivot) แล้วทำซ้ำในแต่ละฝั่ง',
                content:'Quick Sort ทำงานไวมาก โดยเลือกค่าหนึ่งเป็น Pivot จากนั้นจัดกลุ่มข้อมูล: ตัวที่น้อยกว่า Pivot ไปซ้าย, มากกว่าไปขวา แล้วทำซ้ำกระบวนการนี้กับกลุ่มย่อยทางซ้ายและขวา',
                apps: ['ฟังก์ชัน Sort มาตรฐานในหลายภาษา (C++, Java primitives)', 'ระบบปฏิบัติการ Unix', 'เกมที่ต้องการความเร็วในการจัดลำดับคะแนน'],
                pros: ['ทำงานเร็วที่สุดในทางปฏิบัติ (Average Case)', 'ไม่ใช้หน่วยความจำเพิ่มมากนัก (In-place variant)'],
                cons: ['ไม่เสถียร (Unstable)', 'กรณีแย่สุด (Worst Case) อาจช้าถึง O(n²) ถ้าเลือก Pivot ไม่ดี']
            }
        ];
        const searchingAlgos=[
            {
                key:'linear',name:'Linear Search',desc:'ค้นหาตามลำดับ',color:'border-orange-400',textColor:'text-orange-600',
                concept:'ไล่ดูข้อมูลทีละตัวตั้งแต่ต้นจนจบ ว่าตรงกับสิ่งที่หาหรือไม่',
                content:'Linear Search คือการค้นหาแบบตรงไปตรงมาที่สุด โดยเริ่มดูข้อมูลตั้งแต่ตัวแรก ตัวที่สอง ไปเรื่อยๆ จนกว่าจะเจอ หรือจนกว่าข้อมูลจะหมด ข้อดีคือข้อมูลไม่ต้องเรียงลำดับมาก่อน แต่ข้อเสียคือช้าถ้าข้อมูลเยอะ',
                apps: ['หาของในกระเป๋า', 'ค้นหาในรายการที่ไม่ได้เรียงลำดับ', 'ค้นหาข้อมูลที่มีจำนวนน้อยๆ (< 100 ตัว)'],
                pros: ['ข้อมูลไม่ต้องเรียงลำดับก่อน', 'เขียนง่ายที่สุด', 'เหมาะกับข้อมูลที่มีการเพิ่ม/ลบบ่อยๆ'],
                cons: ['ช้ามากถ้าข้อมูลมีเยอะ (O(n))', 'ไม่มีประสิทธิภาพสำหรับการค้นหาซ้ำๆ']
            },
            {
                key:'binary',name:'Binary Search',desc:'ค้นหาแบบทวิภาค',color:'border-teal-400',textColor:'text-teal-600',
                concept:'แบ่งครึ่งข้อมูลแล้วดูว่าค่าที่หาอยู่ฝั่งซ้ายหรือขวา (ข้อมูลต้องเรียงลำดับแล้ว)',
                content:'Binary Search มีประสิทธิภาพสูงมาก แต่ข้อมูล "ต้องเรียงลำดับแล้ว" เท่านั้น หลักการคือดูตัวตรงกลาง ถ้าตัวที่หา "น้อยกว่า" ตัวกลาง ก็ไปหาแค่ฝั่งซ้าย ถ้า "มากกว่า" ก็ไปหาแค่ฝั่งขวา ตัดข้อมูลทิ้งทีละครึ่งเสมอ',
                apps: ['พจนานุกรม (Dictionary)', 'การค้นหาในฐานข้อมูล (Database Indexing)', 'ระบบ Autocomplete ของ Google'],
                pros: ['เร็วมากแม้ข้อมูลจะมีเป็นล้านตัว (O(log n))', 'มีประสิทธิภาพสูงในการค้นหาซ้ำๆ'],
                cons: ['ข้อมูล "ต้องเรียงลำดับ" ก่อนเสมอ', 'โครงสร้างข้อมูลต้องเข้าถึงแบบสุ่มได้ (เช่น Array) ถึงจะเร็ว']
            }
        ];
        
        const quizQuestions=[{question:"อัลกอริทึมใดเปรียบเทียบข้อมูลคู่ที่อยู่ติดกัน?",options:["Insertion","Bubble","Quick","Merge"],correct:1},{question:"Concept ของ Selection Sort?",options:["แบ่งแยก","แทรกไพ่","หาค่าน้อยสุด","หาค่ากลาง"],correct:2},{question:"Binary Search ต้องมีเงื่อนไขใด?",options:["เป็นตัวเลข","เรียงลำดับแล้ว","จำนวนคู่","ไม่เกิน 100"],correct:1},{question:"Linear Search เหมาะกับข้อมูลแบบใด?",options:["มหาศาล","เรียงแล้ว","น้อย/ไม่เรียง","ติดลบ"],correct:2},{question:"Quick Sort ใช้หลักการใด?",options:["Pivot","สลับคู่","ค่าต่ำสุด","รวมกลุ่ม"],correct:0},{question:"อัลกอริทึมใดเหมือน 'เรียงไพ่'?",options:["Bubble","Merge","Insertion","Selection"],correct:2},{question:"Binary Search 1,000 ตัว ค้นกี่ครั้ง?",options:["1000","500","10","100"],correct:2},{question:"Merge Sort เป็นแบบใด?",options:["Greedy","Divide & Conquer","Dynamic","Brute Force"],correct:1},{question:"ข้อมูลเรียงเกือบเสร็จ อะไรเร็วสุด?",options:["Insertion","Selection","Merge","Quick"],correct:0},{question:"ข้อเสีย Bubble Sort?",options:["ยาก","เมมเยอะ","ช้ามาก","ทศนิยมไม่ได้"],correct:2},{question:"Linear Search Worst Case?",options:["O(1)","O(log n)","O(n)","O(n^2)"],correct:2},{question:"ทำไม Binary เร็วกว่า Linear?",options:["ชอบฐานสอง","ตัดทีละครึ่ง","ไม่เปรียบเทียบ","AI"],correct:1},{question:"Pivot อยู่ในเรื่องใด?",options:["Merge","Bubble","Quick","Insertion"],correct:2},{question:"เรียงเลขที่ 50 คน เขียนง่ายสุด?",options:["Quick","Bubble","Merge","Heap"],correct:1},{question:"ขั้นตอนท้าย Merge Sort?",options:["Divide","Swap","Merge","Pivot"],correct:2}];

        // DB Logic
        const fetchStudents = async () => {
            isLoading.value = true;
            const { data: students, error } = await supabase.from('students').select('*').order('student_code');
            if (error) { alert('Error: ' + error.message); isLoading.value = false; return; }
            const { data: scores } = await supabase.from('scores').select('*').order('created_at', { ascending: false });
            
            studentData.value = students.map(s => {
                const userScore = scores ? scores.find(sc => sc.student_code === s.student_code) : null;
                return { ...s, score: userScore ? userScore.score : undefined };
            });
            // Sort by Number
             studentData.value.sort((a, b) => {
                 const numA = parseInt(a.student_number) || 999;
                 const numB = parseInt(b.student_number) || 999;
                 return numA - numB;
             });
            isLoading.value = false;
        };

        const openEditModal = (student) => {
            if (student) editingStudent.value = { ...student };
            else editingStudent.value = { id: null, student_code: '', name: '', student_number: '' };
            showEditModal.value = true;
        };

        const saveStudent = async () => {
            if (!editingStudent.value.student_code || !editingStudent.value.name) { alert("กรุณากรอกรหัสและชื่อนักเรียน"); return; }
            isLoading.value = true;
            const payload = { student_code: editingStudent.value.student_code, name: editingStudent.value.name, student_number: editingStudent.value.student_number };
            let error;
            if (editingStudent.value.id) { const { error: u } = await supabase.from('students').update(payload).eq('id', editingStudent.value.id); error = u; }
            else { const { error: i } = await supabase.from('students').insert([payload]); error = i; }
            if (error) alert("บันทึกไม่สำเร็จ: " + error.message); else { showEditModal.value = false; fetchStudents(); }
            isLoading.value = false;
        };

        const deleteStudent = async (id) => {
            if (!confirm("ยืนยันการลบนักเรียนคนนี้?")) return;
            isLoading.value = true;
            const { error } = await supabase.from('students').delete().eq('id', id);
            if (error) alert("ลบไม่สำเร็จ: " + error.message); else fetchStudents();
            isLoading.value = false;
        };

        // --- Delete All Function ---
        const deleteAllStudents = async () => {
            if (!confirm("⚠️ คำเตือน: คุณต้องการลบข้อมูลนักเรียน 'ทั้งหมด' ใช่หรือไม่?\n\nข้อมูลคะแนนจะหายไปด้วย และกู้คืนไม่ได้")) return;
            if (!confirm("ยืนยันครั้งสุดท้าย: ลบทั้งหมด?")) return;
            isLoading.value = true;
            const { error } = await supabase.from('students').delete().neq('id', 0); 
            if (error) { alert("เกิดข้อผิดพลาดในการลบ: " + error.message); } 
            else { alert("ลบข้อมูลทั้งหมดเรียบร้อยแล้ว"); fetchStudents(); }
            isLoading.value = false;
        };

        // --- Excel Upload (FIXED: Smart Header Detection) ---
        const handleFileUpload = (event) => {
            const file = event.target.files[0];
            if(!file) return;
            isLoading.value = true;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    let jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    // --- FIX: Check for header before slicing ---
                    if (jsonData.length > 0) {
                         const firstCell = String(jsonData[0][0] || "").toLowerCase();
                         const secondCell = String(jsonData[0][1] || "").toLowerCase();
                         if (firstCell.includes("code") || firstCell.includes("รหัส") || firstCell.includes("id") || secondCell.includes("name") || secondCell.includes("ชื่อ")) {
                             jsonData = jsonData.slice(1);
                         }
                    }

                    // Col 0: Code, Col 1: Name, Col 2: Number
                    const newStudents = jsonData.map(row => ({
                        student_code: String(row[0] || "").trim(),
                        name: row[1],
                        student_number: row[2] ? String(row[2]).trim() : null
                    })).filter(s => s.student_code && s.name && s.student_code !== 'undefined');

                    if(newStudents.length > 0) {
                        const { error } = await supabase.from('students').upsert(newStudents, { onConflict: 'student_code' });
                        if (error) throw error;
                        alert(`บันทึกข้อมูลสำเร็จ: ${newStudents.length} คน`);
                        fetchStudents();
                    } else {
                        alert("ไม่พบข้อมูล หรือไฟล์ผิดรูปแบบ");
                    }
                } catch (err) { alert("Error: " + err.message); } 
                finally { isLoading.value = false; }
            };
            reader.readAsArrayBuffer(file);
        };

        const handleLogin = async () => {
            const input = loginInput.value.trim();
            loginError.value = '';
            if (!input) return;
            isLoading.value = true;
            if (input.toLowerCase() === 'admin') {
                if (!showPasswordInput.value) { showPasswordInput.value = true; isLoading.value = false; return; }
                if (passwordInput.value === '1234') { 
                    currentUser.value = { student_code: 'ADMIN', name: 'คุณครูผู้สอน', role: 'admin' };
                    currentView.value = 'teacher_dashboard';
                    fetchStudents();
                    resetLoginInputs();
                } else { loginError.value = 'รหัสผ่านผิด'; }
                isLoading.value = false; return;
            }
            const { data, error } = await supabase.from('students').select('*').eq('student_code', input).single();
            if (data) {
                currentUser.value = { ...data, role: 'student' };
                currentView.value = 'menu';
                resetLoginInputs();
            } else { loginError.value = 'ไม่พบรหัสนักเรียน'; }
            isLoading.value = false;
        };

        const resetLoginInputs = () => { loginInput.value=''; passwordInput.value=''; showPasswordInput.value=false; loginError.value=''; };
        const logout = () => { if (confirm("ออกจากระบบ?")) { currentUser.value=null; currentView.value='login'; resetLoginInputs(); resetQuiz(); } };

        // Quiz & Visualizer logic
        const currentQuestionIndex = ref(0);
        const selectedAnswer = ref(null);
        const score = ref(0);
        const quizFinished = ref(false);
        const startQuiz = () => { resetQuiz(); currentView.value = 'quiz'; };
        const resetQuiz = () => { currentQuestionIndex.value = 0; selectedAnswer.value = null; score.value = 0; quizFinished.value = false; };
        const selectAnswer = (idx) => { selectedAnswer.value = idx; };
        const nextQuestion = async () => {
            if (selectedAnswer.value === quizQuestions[currentQuestionIndex.value].correct) score.value++;
            if (currentQuestionIndex.value < quizQuestions.length - 1) { currentQuestionIndex.value++; selectedAnswer.value = null; } 
            else { 
                quizFinished.value = true;
                if (currentUser.value && currentUser.value.role !== 'admin') {
                    isSavingScore.value = true;
                    await supabase.from('scores').insert({ student_code: currentUser.value.student_code, score: score.value });
                    isSavingScore.value = false;
                }
            }
        };

        const sleep=(ms)=>new Promise(r=>setTimeout(r,ms));
        const getBarColor=(i)=>activeIndices.value.includes(i)?'#facc15':sortedIndices.value.includes(i)?'#22c55e':'#6366f1';
        const getIcon=(k)=>'ph '+(({bubble:'ph-circles-three',selection:'ph-cursor-click',insertion:'ph-cards',merge:'ph-arrows-merge',quick:'ph-lightning',linear:'ph-arrow-right',binary:'ph-arrows-split'}[k])||'ph-code');
        const resetArray=()=>{
             const count=window.innerWidth<600?10:15;
             if(activeTopic.value?.key==='binary')dataArray.value=Array.from({length:count},()=>Math.floor(Math.random()*180)+20).sort((a,b)=>a-b);
             else dataArray.value=Array.from({length:count},()=>Math.floor(Math.random()*180)+20);
             activeIndices.value=[];sortedIndices.value=[];statusMessage.value='พร้อมทำงาน';
        };
        const selectTopic=(a)=>{activeTopic.value=a;currentView.value='content';resetArray();};
        const runAlgorithm=async()=>{
            if(isSorting.value)return;isSorting.value=true;statusMessage.value='...';activeIndices.value=[];sortedIndices.value=[];
            const arr=[...dataArray.value]; const k=activeTopic.value.key;
            if(k==='bubble')await bubbleSort(arr);else if(k==='selection')await selectionSort(arr);else if(k==='insertion')await insertionSort(arr);else if(k==='linear')await linearSearch(arr);else if(k==='binary')await binarySearch(arr);else await bubbleSort(arr);
            isSorting.value=false;statusMessage.value='Done!';
        };
        const bubbleSort=async(a)=>{for(let i=0;i<a.length;i++){for(let j=0;j<a.length-i-1;j++){activeIndices.value=[j,j+1];await sleep(200);if(a[j]>a[j+1]){[a[j],a[j+1]]=[a[j+1],a[j]];dataArray.value=[...a];await sleep(200);}}sortedIndices.value.push(a.length-i-1);}sortedIndices.value.push(0);};
        const selectionSort=async(a)=>{for(let i=0;i<a.length;i++){let m=i;activeIndices.value=[i];for(let j=i+1;j<a.length;j++){activeIndices.value=[m,j];await sleep(150);if(a[j]<a[m])m=j;}if(m!==i){[a[i],a[m]]=[a[m],a[i]];dataArray.value=[...a];await sleep(200);}sortedIndices.value.push(i);}};
        const insertionSort=async(a)=>{sortedIndices.value.push(0);for(let i=1;i<a.length;i++){let k=a[i],j=i-1;activeIndices.value=[i];await sleep(300);while(j>=0&&a[j]>k){activeIndices.value=[j,j+1];a[j+1]=a[j];dataArray.value=[...a];await sleep(200);j--;}a[j+1]=k;dataArray.value=[...a];sortedIndices.value.push(i);await sleep(200);}sortedIndices.value=Array.from({length:a.length},(_,i)=>i);};
        const linearSearch=async(a)=>{const t=a[Math.floor(Math.random()*a.length)];statusMessage.value=`Find ${t}`;await sleep(800);for(let i=0;i<a.length;i++){activeIndices.value=[i];await sleep(300);if(a[i]===t){sortedIndices.value=[i];activeIndices.value=[];return;}}};
        const binarySearch=async(a)=>{const t=a[Math.floor(Math.random()*a.length)];statusMessage.value=`Find ${t}`;await sleep(800);let l=0,r=a.length-1;while(l<=r){let m=Math.floor((l+r)/2);activeIndices.value=[m];await sleep(500);if(a[m]===t){sortedIndices.value=[m];activeIndices.value=[];return;}else if(a[m]<t)l=m+1;else r=m-1;}};

        const enterTeachingMode = () => { currentView.value = 'menu'; };
        const fetchScores = fetchStudents;

        return {
            currentView, loginInput, passwordInput, showPasswordInput, loginError, currentUser, isAdmin, isLoading, isSavingScore,
            studentData, fetchStudents, fetchScores,
            showEditModal, editingStudent, openEditModal, saveStudent, deleteStudent, deleteAllStudents,
            sortingAlgos, searchingAlgos, activeTopic, dataArray, isSorting, activeIndices, sortedIndices, statusMessage,
            handleFileUpload, handleLogin, enterTeachingMode, logout, selectTopic, resetArray, runAlgorithm, getBarColor, getIcon,
            quizQuestions, currentQuestionIndex, selectedAnswer, score, quizFinished, startQuiz, selectAnswer, nextQuestion
        };
    }
}).mount('#app');
</script>

</body>
</html>
