<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS Learning: Sorting & Searching (M.4)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f3f4f6; }
        .bar { transition: all 0.3s ease; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.5s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .student-list::-webkit-scrollbar { width: 8px; }
        .student-list::-webkit-scrollbar-track { background: #f1f1f1; }
        .student-list::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

<div id="app" class="min-h-screen flex flex-col">

    <nav class="p-4 shadow-lg flex justify-between items-center z-50 transition-colors duration-300"
         :class="isAdmin ? 'bg-slate-800 text-white' : 'bg-indigo-600 text-white'">
        <div class="flex items-center gap-2">
            <i class="ph ph-database text-2xl"></i>
            <span class="text-xl font-bold">
                {{ isAdmin ? 'Teacher Panel (Online DB)' : 'AlgoLearn (ม.4)' }}
            </span>
        </div>
        <div v-if="currentUser" class="flex items-center gap-4">
            <div class="text-right hidden sm:block">
                <div class="font-bold">{{ currentUser.name }}</div>
                <div class="text-xs opacity-80">{{ isAdmin ? 'สถานะ: ครูผู้สอน' : 'รหัสนักเรียน: ' + currentUser.student_code }}</div>
            </div>
            <button @click="logout" class="bg-red-500 hover:bg-red-600 px-3 py-1 rounded text-sm transition shadow">
                <i class="ph ph-sign-out"></i> <span class="hidden sm:inline">ออกจากระบบ</span>
            </button>
        </div>
    </nav>

    <main class="flex-grow p-6 container mx-auto relative">

        <transition name="fade">
        <div v-if="currentView === 'login'" class="flex flex-col items-center justify-center h-[80vh]">
            <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md text-center border-t-4 border-indigo-500 relative overflow-hidden">
                <h2 class="text-2xl font-bold mb-2 text-indigo-700">เข้าสู่ระบบห้องเรียน</h2>
                <p class="text-gray-500 mb-8">วิชาวิทยาการคอมพิวเตอร์ 1</p>
                
                <div class="mb-2 space-y-4 relative z-10">
                    <div>
                        <input v-model="loginInput" @keyup.enter="handleLogin" type="text" placeholder="กรอกรหัสนักเรียน / Admin" 
                               class="w-full p-4 border border-gray-300 rounded-xl focus:ring-4 focus:ring-indigo-100 focus:border-indigo-500 outline-none text-center text-lg transition-all shadow-sm">
                    </div>
                    
                    <div v-if="showPasswordInput" class="animate-bounce-in">
                        <input v-model="passwordInput" @keyup.enter="handleLogin" type="password" placeholder="รหัสผ่านผู้สอน (1234)" 
                               class="w-full p-4 border border-gray-300 rounded-xl focus:ring-4 focus:ring-slate-200 focus:border-slate-500 outline-none text-center text-lg bg-slate-50 shadow-sm">
                    </div>

                    <button @click="handleLogin" :disabled="isLoading"
                            class="w-full text-white p-4 rounded-xl font-bold text-lg transition shadow-lg transform active:scale-95 flex justify-center items-center gap-2"
                            :class="showPasswordInput ? 'bg-slate-700 hover:bg-slate-800' : 'bg-indigo-600 hover:bg-indigo-700'">
                        <span v-if="!isLoading">{{ showPasswordInput ? 'ยืนยันตัวตน Admin' : 'เข้าสู่บทเรียน' }}</span>
                        <span v-else>กำลังโหลด...</span>
                    </button>
                    
                    <p v-if="loginError" class="text-red-500 text-sm mt-2">{{ loginError }}</p>
                </div>
            </div>
            <p class="mt-6 text-gray-400 text-sm">System powered by Supabase</p>
        </div>
        </transition>

        <transition name="fade">
        <div v-if="currentView === 'teacher_dashboard'" class="py-4">
            <h1 class="text-2xl font-bold text-slate-700 mb-6 flex items-center gap-2">
                <i class="ph ph-control"></i> แผงควบคุมผู้สอน (Connected)
            </h1>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-1 space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-green-500">
                        <h3 class="font-bold text-lg text-slate-800 mb-2">อัปเดตรายชื่อนักเรียน</h3>
                        <p class="text-sm text-gray-500 mb-4">ไฟล์ Excel ต้องมีคอลัมน์ A (รหัส) และ B (ชื่อ)</p>
                        
                        <label class="cursor-pointer bg-green-50 hover:bg-green-100 text-green-700 w-full py-3 rounded-lg border border-green-200 border-dashed flex items-center justify-center gap-2 transition hover:shadow-md">
                            <i v-if="!isLoading" class="ph ph-microsoft-excel-logo text-xl"></i> 
                            <i v-else class="ph ph-spinner animate-spin text-xl"></i>
                            <span>{{ isLoading ? 'กำลังบันทึก...' : 'เลือกไฟล์ Excel' }}</span>
                            <input type="file" @change="handleFileUpload" class="hidden" accept=".xlsx, .xls" :disabled="isLoading">
                        </label>
                    </div>
                    
                     <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-purple-500">
                        <h3 class="font-bold text-lg text-slate-800 mb-2">รายงานคะแนน</h3>
                        <p class="text-sm text-gray-500 mb-4">ดูคะแนนสอบล่าสุดของนักเรียน</p>
                        <button @click="fetchScores" class="w-full bg-purple-100 text-purple-700 py-2 rounded-lg hover:bg-purple-200 transition text-sm font-bold">
                            <i class="ph ph-arrow-clockwise"></i> รีเฟรชคะแนน
                        </button>
                    </div>

                    <div class="bg-gradient-to-br from-slate-700 to-slate-800 text-white p-6 rounded-xl shadow-lg">
                        <h3 class="font-bold text-xl mb-4">โหมดการสอน (Demo)</h3>
                        <button @click="enterTeachingMode" class="w-full bg-white text-slate-900 py-3 rounded-lg font-bold hover:bg-blue-50 transition flex items-center justify-center gap-2 shadow-lg">
                            <i class="ph ph-presentation-chart"></i> เริ่มการสอน
                        </button>
                    </div>
                </div>

                <div class="md:col-span-2 bg-white rounded-xl shadow-md overflow-hidden flex flex-col h-[75vh]">
                    <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                        <h3 class="font-bold text-slate-700 flex items-center gap-2">
                            <i class="ph ph-users"></i> รายชื่อและคะแนน ({{ studentData.length }})
                        </h3>
                    </div>
                    <div class="overflow-y-auto student-list flex-grow p-0 relative">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-gray-100 text-gray-600 sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th class="p-3 text-sm font-semibold w-1/4">รหัสนักเรียน</th>
                                    <th class="p-3 text-sm font-semibold">ชื่อ-นามสกุล</th>
                                    <th class="p-3 text-sm font-semibold text-center">คะแนนล่าสุด</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-if="studentData.length === 0">
                                    <td colspan="3" class="p-12 text-center text-gray-400">
                                        <i class="ph ph-database text-4xl mb-2"></i><br>
                                        {{ isLoading ? 'กำลังดึงข้อมูล...' : 'ยังไม่มีข้อมูลนักเรียน' }}
                                    </td>
                                </tr>
                                <tr v-for="(student, idx) in studentData" :key="idx" class="border-b last:border-0 hover:bg-slate-50 transition">
                                    <td class="p-3 text-slate-600 font-mono border-r border-gray-100">{{ student.student_code }}</td>
                                    <td class="p-3 text-slate-800 font-medium">{{ student.name }}</td>
                                    <td class="p-3 text-center">
                                        <span v-if="student.score !== undefined" class="font-bold" 
                                              :class="student.score >= 8 ? 'text-green-600' : 'text-orange-500'">
                                            {{ student.score }} / 15
                                        </span>
                                        <span v-else class="text-gray-300">-</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        </transition>

        <transition name="fade">
        <div v-if="currentView === 'menu'" class="py-8">
            <div class="flex items-center justify-between mb-8">
                <h1 class="text-3xl font-bold text-slate-700">เลือกหัวข้อการเรียนรู้</h1>
                <button v-if="isAdmin" @click="currentView = 'teacher_dashboard'" class="flex items-center gap-2 text-slate-500 hover:text-slate-800 font-semibold bg-slate-200 px-4 py-2 rounded-lg transition">
                    <i class="ph ph-arrow-left"></i> กลับไปหน้า Admin
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="col-span-full mb-2 border-b pb-2 text-lg font-bold text-indigo-600 flex items-center gap-2">
                    <i class="ph ph-arrows-down-up"></i> การจัดเรียงข้อมูล (Sorting)
                </div>
                
                <div v-for="algo in sortingAlgos" :key="algo.key" @click="selectTopic(algo)" 
                     class="bg-white p-6 rounded-xl shadow-md cursor-pointer card-hover border-l-4"
                     :class="algo.color">
                    <div class="flex justify-between items-start">
                        <h3 class="font-bold text-xl mb-2">{{ algo.name }}</h3>
                        <i :class="getIcon(algo.key)" class="text-2xl opacity-20"></i>
                    </div>
                    <p class="text-sm text-gray-500">{{ algo.desc }}</p>
                </div>

                <div class="col-span-full mt-6 mb-2 border-b pb-2 text-lg font-bold text-pink-600 flex items-center gap-2">
                    <i class="ph ph-magnifying-glass"></i> การค้นหาข้อมูล (Searching)
                </div>

                <div v-for="algo in searchingAlgos" :key="algo.key" @click="selectTopic(algo)" 
                     class="bg-white p-6 rounded-xl shadow-md cursor-pointer card-hover border-l-4"
                     :class="algo.color">
                    <h3 class="font-bold text-xl mb-2">{{ algo.name }}</h3>
                    <p class="text-sm text-gray-500">{{ algo.desc }}</p>
                </div>
            </div>

            <div class="mt-12 text-center">
                <button @click="startQuiz" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white text-xl font-bold px-10 py-4 rounded-full shadow-lg hover:scale-105 transition transform flex items-center gap-3 mx-auto">
                    <i class="ph ph-exam text-3xl"></i> ทำแบบทดสอบ (15 ข้อ)
                </button>
            </div>
        </div>
        </transition>

        <transition name="fade">
        <div v-if="currentView === 'content' && activeTopic" class="h-full">
            <button @click="currentView = 'menu'" class="mb-4 text-gray-500 hover:text-indigo-600 flex items-center gap-1 font-medium transition">
                <i class="ph ph-arrow-left"></i> กลับเมนูหลัก
            </button>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full">
                <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md overflow-y-auto max-h-[80vh]">
                    <h2 class="text-2xl font-bold mb-4 flex items-center gap-2" :class="activeTopic.textColor">
                        <i class="ph ph-book-bookmark"></i> {{ activeTopic.name }}
                    </h2>
                    <div class="prose text-slate-600 text-sm leading-relaxed whitespace-pre-line mb-6">
                        {{ activeTopic.content }}
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg text-xs font-mono border-l-4 border-gray-400">
                        <strong class="text-gray-700 block mb-1">KEY CONCEPT:</strong> 
                        {{ activeTopic.concept }}
                    </div>
                </div>

                <div class="lg:col-span-2 bg-slate-800 rounded-xl shadow-md p-6 flex flex-col items-center justify-center relative overflow-hidden min-h-[450px]">
                    <div class="absolute top-4 left-4 text-white/50 text-sm font-mono">Visualizer Mode</div>
                    <div class="flex items-end justify-center gap-1 h-64 w-full mb-8 px-4">
                        <div v-for="(val, idx) in dataArray" :key="idx"
                             :style="{ height: val + 'px', backgroundColor: getBarColor(idx) }"
                             class="flex-1 max-w-[40px] rounded-t bar flex items-end justify-center pb-1 text-[10px] text-white font-bold relative shadow-sm">
                             <span v-if="dataArray.length <= 20">{{ val }}</span>
                        </div>
                    </div>
                    <div class="flex gap-4 flex-wrap justify-center z-10">
                        <button @click="resetArray" :disabled="isSorting" class="bg-gray-700 hover:bg-gray-600 text-white px-6 py-2 rounded-full transition disabled:opacity-50">
                            <i class="ph ph-arrows-clockwise"></i> สุ่มใหม่
                        </button>
                        <button @click="runAlgorithm" :disabled="isSorting" 
                                class="bg-green-500 hover:bg-green-600 text-white px-10 py-2 rounded-full font-bold transition shadow-lg shadow-green-500/30 flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i v-if="!isSorting" class="ph ph-play-circle text-xl"></i>
                            <i v-else class="ph ph-spinner animate-spin text-xl"></i>
                            {{ isSorting ? 'กำลังทำงาน...' : 'เริ่มทำงาน' }}
                        </button>
                    </div>
                    <div v-if="statusMessage" class="mt-8 text-yellow-300 font-mono text-sm bg-black/40 px-6 py-2 rounded-full backdrop-blur-sm">
                        > {{ statusMessage }}
                    </div>
                </div>
            </div>
        </div>
        </transition>

        <transition name="fade">
        <div v-if="currentView === 'quiz'" class="max-w-2xl mx-auto py-8">
            <div v-if="!quizFinished">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold flex items-center gap-2">
                        <i class="ph ph-pencil-simple-slash"></i> แบบทดสอบ
                    </h2>
                    <span class="text-indigo-600 bg-indigo-100 px-3 py-1 rounded-full text-sm font-bold">
                        ข้อที่ {{ currentQuestionIndex + 1 }} / {{ quizQuestions.length }}
                    </span>
                </div>

                <div class="bg-white p-8 rounded-2xl shadow-lg border-t-8 border-indigo-500 min-h-[300px] flex flex-col justify-between">
                    <div>
                        <h3 class="text-xl font-semibold mb-8 leading-relaxed">{{ quizQuestions[currentQuestionIndex].question }}</h3>
                        <div class="space-y-3">
                            <button v-for="(option, idx) in quizQuestions[currentQuestionIndex].options" :key="idx"
                                    @click="selectAnswer(idx)"
                                    class="w-full text-left p-4 rounded-xl border-2 hover:bg-indigo-50 hover:border-indigo-300 transition duration-200 group"
                                    :class="selectedAnswer === idx ? 'bg-indigo-50 border-indigo-500 ring-2 ring-indigo-200' : 'border-gray-100'">
                                <span class="font-bold mr-3 w-6 inline-block" 
                                      :class="selectedAnswer === idx ? 'text-indigo-600' : 'text-gray-400 group-hover:text-indigo-400'">
                                    {{ ['A','B','C','D'][idx] }}.
                                </span> 
                                {{ option }}
                            </button>
                        </div>
                    </div>
                </div>

                <div class="mt-8 flex justify-end">
                    <button @click="nextQuestion" :disabled="selectedAnswer === null"
                            class="bg-indigo-600 text-white px-10 py-3 rounded-full shadow-lg hover:bg-indigo-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition transform active:scale-95 flex items-center gap-2 font-bold">
                        {{ currentQuestionIndex === quizQuestions.length - 1 ? 'ส่งคำตอบ' : 'ข้อถัดไป' }} <i class="ph ph-arrow-right"></i>
                    </button>
                </div>
            </div>

            <div v-else class="text-center bg-white p-12 rounded-3xl shadow-2xl border-t-8" 
                 :class="score >= 8 ? 'border-green-500' : 'border-orange-500'">
                
                <div class="mb-6">
                    <i v-if="score >= 12" class="ph ph-trophy text-7xl text-yellow-400 animate-bounce"></i>
                    <i v-else-if="score >= 8" class="ph ph-thumbs-up text-7xl text-green-400"></i>
                    <i v-else class="ph ph-smiley-sad text-7xl text-orange-400"></i>
                </div>
                
                <h2 class="text-3xl font-bold mb-2 text-slate-700">ผลคะแนนของคุณ</h2>
                <p class="text-gray-500 mb-8 font-medium text-lg">{{ currentUser.name }}</p>
                
                <div class="inline-block bg-slate-50 px-10 py-8 rounded-3xl mb-8 border border-slate-100 shadow-inner">
                    <div class="text-7xl font-black mb-2" :class="score >= 8 ? 'text-green-600' : 'text-orange-500'">{{ score }}</div>
                    <div class="text-gray-400 font-medium">คะแนนเต็ม 15</div>
                </div>
                
                <div v-if="isSavingScore" class="text-blue-500 mb-4 animate-pulse">กำลังบันทึกคะแนนลงระบบ...</div>
                <div v-else class="text-green-500 mb-4 font-bold flex items-center justify-center gap-1"><i class="ph ph-check-circle"></i> บันทึกคะแนนเรียบร้อย</div>

                <div class="flex justify-center gap-4">
                     <button @click="startQuiz" class="px-8 py-3 rounded-xl border-2 border-gray-200 hover:bg-gray-50 text-gray-600 font-bold transition">สอบแก้ตัว</button>
                     <button @click="currentView = 'menu'" class="bg-indigo-600 text-white px-8 py-3 rounded-xl hover:bg-indigo-700 shadow-lg font-bold transition">กลับเมนูหลัก</button>
                </div>
            </div>
        </div>
        </transition>

    </main>
</div>

<script>
const { createApp, ref, computed, onMounted } = Vue;

// --------------------------------------------------------
// ⚠️ SETUP SUPABASE CONFIGURATION HERE
// --------------------------------------------------------
const SUPABASE_URL = 'https://bzfhixfeeenkknnilbgw.supabase.co'; 
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6ZmhpeGZlZWVua2tubmlsYmd3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxNjMxOTMsImV4cCI6MjA4NTczOTE5M30.gFjptTI5eB7RHOVsmwMi3QsKkmD35R5Poh6ofLDgOWo';
// --------------------------------------------------------

createApp({
    setup() {
        // Initialize Supabase Client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- State ---
        const currentView = ref('login');
        const loginInput = ref('');
        const passwordInput = ref('');
        const showPasswordInput = ref(false);
        const loginError = ref('');
        const currentUser = ref(null);
        const isLoading = ref(false);
        const isSavingScore = ref(false);
        
        const studentData = ref([]); // Now loaded from DB
        
        const activeTopic = ref(null);
        const dataArray = ref([]);
        const isSorting = ref(false);
        const activeIndices = ref([]); 
        const sortedIndices = ref([]); 
        const statusMessage = ref('');

        const isAdmin = computed(() => currentUser.value && currentUser.value.role === 'admin');

        // --- Data Content (Algorithms & Questions) ---
        // (Same content as previous version - Keeping it brief for readability)
        const sortingAlgos = [
            { key: 'bubble', name: 'Bubble Sort', desc: 'เรียงลำดับแบบฟองสบู่', color: 'border-blue-400', textColor: 'text-blue-600', concept: 'เปรียบเทียบข้อมูลคู่ติดกัน ถ้าตัวหน้ามากกว่าตัวหลังให้สลับที่ ทำซ้ำจนกว่าจะเรียงเสร็จ', content: 'Bubble Sort เป็นอัลกอริทึมที่ง่ายที่สุด...' },
            { key: 'selection', name: 'Selection Sort', desc: 'เลือกค่าที่น้อยที่สุด', color: 'border-green-400', textColor: 'text-green-600', concept: 'ค้นหาค่าที่น้อยที่สุดในส่วนที่ยังไม่เรียง แล้วนำมาวางต่อท้ายส่วนที่เรียงแล้ว', content: 'Selection Sort ทำงานโดยแบ่งข้อมูลเป็น 2 ส่วน...' },
            { key: 'insertion', name: 'Insertion Sort', desc: 'แทรกไพ่ในมือ', color: 'border-yellow-400', textColor: 'text-yellow-600', concept: 'หยิบข้อมูลทีละตัว แล้วนำไป "แทรก" ในตำแหน่งที่ถูกต้อง', content: 'Insertion Sort เปรียบเสมือนการเรียงไพ่ในมือ...' },
            { key: 'merge', name: 'Merge Sort', desc: 'แบ่งแยกและเอาชนะ', color: 'border-purple-400', textColor: 'text-purple-600', concept: 'แบ่งข้อมูลเป็นกลุ่มย่อยจนเหลือตัวเดียว แล้วนำกลับมา "ผสาน" กัน', content: 'Merge Sort ใช้วิธี Divide and Conquer...' },
            { key: 'quick', name: 'Quick Sort', desc: 'เลือกจุดหมุน (Pivot)', color: 'border-red-400', textColor: 'text-red-600', concept: 'เลือกค่า Pivot แบ่งข้อมูลเป็น 2 ฝั่ง แล้วทำซ้ำ', content: 'Quick Sort ทำงานไวมาก โดยเลือกค่าหนึ่งเป็น Pivot...' },
        ];
        const searchingAlgos = [
            { key: 'linear', name: 'Linear Search', desc: 'ค้นหาตามลำดับ', color: 'border-orange-400', textColor: 'text-orange-600', concept: 'ไล่ดูข้อมูลทีละตัวตั้งแต่ต้นจนจบ', content: 'Linear Search คือการค้นหาแบบตรงไปตรงมาที่สุด...' },
            { key: 'binary', name: 'Binary Search', desc: 'ค้นหาแบบทวิภาค', color: 'border-teal-400', textColor: 'text-teal-600', concept: 'แบ่งครึ่งข้อมูลแล้วดูว่าค่าที่หาอยู่ฝั่งซ้ายหรือขวา', content: 'Binary Search ต้องใช้กับข้อมูลที่เรียงลำดับแล้วเท่านั้น...' }
        ];

        // --- DB Logic: Fetch Students & Scores ---
        const fetchStudents = async () => {
            isLoading.value = true;
            // 1. Get Students
            const { data: students, error } = await supabase.from('students').select('*').order('student_code');
            if (error) { alert('Error fetching students: ' + error.message); isLoading.value = false; return; }
            
            // 2. Get Latest Scores
            const { data: scores, error: scoreErr } = await supabase.from('scores').select('*').order('created_at', { ascending: false });
            
            // 3. Map Scores to Students
            studentData.value = students.map(s => {
                // Find latest score for this student
                const userScore = scores ? scores.find(sc => sc.student_code === s.student_code) : null;
                return { ...s, score: userScore ? userScore.score : undefined };
            });
            isLoading.value = false;
        };

        // --- Logic: Upload Excel to Supabase ---
        const handleFileUpload = (event) => {
            const file = event.target.files[0];
            if(!file) return;
            isLoading.value = true;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    const newStudents = jsonData.slice(1).map(row => ({
                        student_code: String(row[0]).trim(),
                        name: row[1]
                    })).filter(s => s.student_code && s.name && s.student_code !== 'undefined');

                    if(newStudents.length > 0) {
                        // Upsert into Supabase (Insert or Update if exists)
                        const { error } = await supabase.from('students').upsert(newStudents, { onConflict: 'student_code' });
                        
                        if (error) throw error;
                        
                        alert(`บันทึกข้อมูลสำเร็จ: ${newStudents.length} คน`);
                        fetchStudents(); // Refresh list
                    } else {
                        alert("ไม่พบข้อมูลในไฟล์ หรือรูปแบบไฟล์ไม่ถูกต้อง");
                    }
                } catch (err) {
                    alert("เกิดข้อผิดพลาด: " + err.message);
                } finally {
                    isLoading.value = false;
                }
            };
            reader.readAsArrayBuffer(file);
        };

        // --- Login Logic (Check DB) ---
        const handleLogin = async () => {
            const input = loginInput.value.trim();
            loginError.value = '';
            if (!input) return;
            isLoading.value = true;

            // 1. Admin Check
            if (input.toLowerCase() === 'admin') {
                if (!showPasswordInput.value) {
                    showPasswordInput.value = true;
                    isLoading.value = false;
                    return;
                }
                if (passwordInput.value === '1234') { 
                    currentUser.value = { student_code: 'ADMIN', name: 'คุณครูผู้สอน', role: 'admin' };
                    currentView.value = 'teacher_dashboard';
                    fetchStudents(); // Load data for dashboard
                    resetLoginInputs();
                } else {
                    loginError.value = 'รหัสผ่าน Admin ไม่ถูกต้อง';
                }
                isLoading.value = false;
                return;
            }

            // 2. Student Check via Supabase
            const { data, error } = await supabase
                .from('students')
                .select('*')
                .eq('student_code', input)
                .single();

            if (data) {
                currentUser.value = { ...data, role: 'student' };
                currentView.value = 'menu';
                resetLoginInputs();
            } else {
                loginError.value = 'ไม่พบรหัสนักเรียนนี้ในระบบ';
            }
            isLoading.value = false;
        };

        const resetLoginInputs = () => {
            loginInput.value = '';
            passwordInput.value = '';
            showPasswordInput.value = false;
            loginError.value = '';
        };

        const logout = () => {
            if (confirm("ต้องการออกจากระบบใช่หรือไม่?")) {
                currentUser.value = null;
                currentView.value = 'login';
                resetLoginInputs();
                resetQuiz();
            }
        };

        // --- Quiz Logic with Score Saving ---
        const quizQuestions = [
            { question: "อัลกอริทึมใดเปรียบเทียบข้อมูลคู่ที่อยู่ติดกันและสลับที่?", options: ["Insertion Sort", "Bubble Sort", "Quick Sort", "Merge Sort"], correct: 1 },
            { question: "ข้อใดคือ Concept ของ Selection Sort?", options: ["แบ่งแยกและเอาชนะ", "แทรกข้อมูลเหมือนไพ่", "หาค่าน้อยสุดแล้วนำมาวางข้างหน้า", "หาค่ากลางแล้วแบ่งครึ่ง"], correct: 2 },
            { question: "การค้นหาข้อมูลแบบ Binary Search จำเป็นต้องมีเงื่อนไขใด?", options: ["ข้อมูลต้องเป็นตัวเลขเท่านั้น", "ข้อมูลต้องเรียงลำดับมาก่อน", "ต้องมีข้อมูลจำนวนคู่", "ใช้กับข้อมูลไม่เกิน 100 ตัว"], correct: 1 },
            { question: "Linear Search เหมาะกับข้อมูลแบบใดที่สุด?", options: ["ข้อมูลจำนวนมหาศาล", "ข้อมูลที่เรียงลำดับแล้ว", "ข้อมูลจำนวนน้อยและไม่เรียงลำดับ", "ข้อมูลที่มีค่าติดลบ"], correct: 2 },
            { question: "Quick Sort ใช้หลักการใดในการทำงาน?", options: ["เลือก Pivot แล้วแบ่งกลุ่ม", "สลับคู่ติดกัน", "ค้นหาค่าต่ำสุด", "รวมกลุ่มข้อมูลย่อย"], correct: 0 },
            { question: "อัลกอริทึมใดเปรียบเสมือนการ 'เรียงไพ่ในมือ'?", options: ["Bubble Sort", "Merge Sort", "Insertion Sort", "Selection Sort"], correct: 2 },
            { question: "ถ้าข้อมูลมี 1,000 ตัว Binary Search จะค้นหาสูงสุดกี่ครั้ง (โดยประมาณ)?", options: ["1000 ครั้ง", "500 ครั้ง", "10 ครั้ง (2^10)", "100 ครั้ง"], correct: 2 },
            { question: "Merge Sort จัดอยู่ในประเภทอัลกอริทึมแบบใด?", options: ["Greedy", "Divide and Conquer", "Dynamic Programming", "Brute Force"], correct: 1 },
            { question: "ในกรณีที่ข้อมูลเรียงเกือบเสร็จแล้ว อัลกอริทึมใดมักทำงานได้เร็วที่สุด?", options: ["Insertion Sort", "Selection Sort", "Merge Sort", "Quick Sort"], correct: 0 },
            { question: "ข้อเสียหลักของ Bubble Sort คืออะไร?", options: ["เข้าใจยาก", "ใช้หน่วยความจำเยอะ", "ทำงานช้ามากกับข้อมูลจำนวนเยอะ", "ไม่สามารถเรียงเลขทศนิยมได้"], correct: 2 },
            { question: "Linear Search มี Time Complexity กรณีแย่สุด (Worst Case) เป็นเท่าใด?", options: ["O(1)", "O(log n)", "O(n)", "O(n^2)"], correct: 2 },
            { question: "Binary Search เร็วกว่า Linear Search เพราะอะไร?", options: ["คอมพิวเตอร์ชอบเลขฐานสอง", "ตัดข้อมูลทิ้งทีละครึ่ง", "ไม่ต้องเปรียบเทียบค่า", "ใช้ AI ช่วย"], correct: 1 },
            { question: "การหาค่า Pivot เกี่ยวข้องกับอัลกอริทึมใด?", options: ["Merge Sort", "Bubble Sort", "Quick Sort", "Insertion Sort"], correct: 2 },
            { question: "ถ้าต้องการเรียงข้อมูลนักเรียน 50 คนตามเลขที่ ควรใช้วิธีใดที่เขียนโปรแกรมง่ายที่สุด?", options: ["Quick Sort", "Bubble Sort", "Merge Sort", "Heap Sort"], correct: 1 },
            { question: "ขั้นตอนสุดท้ายของ Merge Sort คืออะไร?", options: ["Divide", "Swap", "Merge (ผสาน)", "Pivot"], correct: 2 },
        ];
        
        const currentQuestionIndex = ref(0);
        const selectedAnswer = ref(null);
        const score = ref(0);
        const quizFinished = ref(false);

        const startQuiz = () => { resetQuiz(); currentView.value = 'quiz'; };
        const resetQuiz = () => { currentQuestionIndex.value = 0; selectedAnswer.value = null; score.value = 0; quizFinished.value = false; };
        const selectAnswer = (idx) => { selectedAnswer.value = idx; };
        
        const nextQuestion = async () => {
            if (selectedAnswer.value === quizQuestions[currentQuestionIndex.value].correct) score.value++;
            
            if (currentQuestionIndex.value < quizQuestions.length - 1) {
                currentQuestionIndex.value++; selectedAnswer.value = null;
            } else {
                quizFinished.value = true;
                // Save Score to DB
                if (currentUser.value && currentUser.value.role !== 'admin') {
                    isSavingScore.value = true;
                    await supabase.from('scores').insert({
                        student_code: currentUser.value.student_code,
                        score: score.value
                    });
                    isSavingScore.value = false;
                }
            }
        };

        // --- Visualizer Functions (Shortened for brevity) ---
        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));
        const getBarColor = (idx) => { if (activeIndices.value.includes(idx)) return '#facc15'; if (sortedIndices.value.includes(idx)) return '#22c55e'; return '#6366f1'; };
        const getIcon = (key) => { const icons = { bubble: 'ph-circles-three', selection: 'ph-cursor-click', insertion: 'ph-cards', merge: 'ph-arrows-merge', quick: 'ph-lightning', linear: 'ph-arrow-right', binary: 'ph-arrows-split' }; return 'ph ' + (icons[key] || 'ph-code'); };
        
        const resetArray = () => {
             const count = window.innerWidth < 600 ? 10 : 15;
             if (activeTopic.value && activeTopic.value.key === 'binary') dataArray.value = Array.from({length: count}, () => Math.floor(Math.random() * 180) + 20).sort((a,b) => a-b);
             else dataArray.value = Array.from({length: count}, () => Math.floor(Math.random() * 180) + 20);
             activeIndices.value = []; sortedIndices.value = []; statusMessage.value = 'พร้อมทำงาน';
        };
        const selectTopic = (algo) => { activeTopic.value = algo; currentView.value = 'content'; resetArray(); };

        const runAlgorithm = async () => {
            if (isSorting.value) return; isSorting.value = true; statusMessage.value = 'กำลังทำงาน...'; activeIndices.value = []; sortedIndices.value = [];
            const arr = [...dataArray.value]; const key = activeTopic.value.key;
            if (key === 'bubble') await bubbleSort(arr); else if (key === 'selection') await selectionSort(arr); else if (key === 'insertion') await insertionSort(arr); else if (key === 'linear') await linearSearch(arr); else if (key === 'binary') await binarySearch(arr); else await bubbleSort(arr);
            isSorting.value = false; statusMessage.value = 'เสร็จสิ้น!';
        };

        // Re-implementing simplified algos
        const bubbleSort = async (arr) => { for (let i=0;i<arr.length;i++) { for (let j=0;j<arr.length-i-1;j++) { activeIndices.value=[j,j+1]; await sleep(200); if(arr[j]>arr[j+1]){ [arr[j],arr[j+1]]=[arr[j+1],arr[j]]; dataArray.value=[...arr]; await sleep(200); } } sortedIndices.value.push(arr.length-i-1); } sortedIndices.value.push(0); };
        const selectionSort = async (arr) => { for(let i=0;i<arr.length;i++){ let min=i; activeIndices.value=[i]; for(let j=i+1;j<arr.length;j++){ activeIndices.value=[min,j]; await sleep(150); if(arr[j]<arr[min]) min=j; } if(min!==i){ [arr[i],arr[min]]=[arr[min],arr[i]]; dataArray.value=[...arr]; await sleep(200); } sortedIndices.value.push(i); } };
        const insertionSort = async (arr) => { sortedIndices.value.push(0); for(let i=1;i<arr.length;i++){ let key=arr[i],j=i-1; activeIndices.value=[i]; await sleep(300); while(j>=0 && arr[j]>key){ activeIndices.value=[j,j+1]; arr[j+1]=arr[j]; dataArray.value=[...arr]; await sleep(200); j--; } arr[j+1]=key; dataArray.value=[...arr]; sortedIndices.value.push(i); await sleep(200); } sortedIndices.value=Array.from({length:arr.length},(_,i)=>i); };
        const linearSearch = async (arr) => { const t=arr[Math.floor(Math.random()*arr.length)]; statusMessage.value=`หา ${t}`; await sleep(800); for(let i=0;i<arr.length;i++){ activeIndices.value=[i]; await sleep(300); if(arr[i]===t){ sortedIndices.value=[i]; activeIndices.value=[]; return; } } };
        const binarySearch = async (arr) => { const t=arr[Math.floor(Math.random()*arr.length)]; statusMessage.value=`หา ${t}`; await sleep(800); let l=0,r=arr.length-1; while(l<=r){ let m=Math.floor((l+r)/2); activeIndices.value=[m]; await sleep(500); if(arr[m]===t){ sortedIndices.value=[m]; activeIndices.value=[]; return; } else if(arr[m]<t) l=m+1; else r=m-1; } };

        const enterTeachingMode = () => { currentView.value = 'menu'; };
        const getFeedback = (s) => s>=12 ? 'ยอดเยี่ยม!' : (s>=8 ? 'ทำได้ดี!' : 'พยายามอีกนิด!');
        const fetchScores = fetchStudents; // Alias for refresh button

        return {
            currentView, loginInput, passwordInput, showPasswordInput, loginError, currentUser, isAdmin, isLoading, isSavingScore,
            studentData, fetchStudents, fetchScores,
            sortingAlgos, searchingAlgos, activeTopic, dataArray, isSorting, activeIndices, sortedIndices, statusMessage,
            handleFileUpload, handleLogin, enterTeachingMode, logout, selectTopic, resetArray, runAlgorithm, getBarColor, getIcon,
            quizQuestions, currentQuestionIndex, selectedAnswer, score, quizFinished, startQuiz, selectAnswer, nextQuestion, getFeedback
        };
    }
}).mount('#app');
</script>

</body>
</html>